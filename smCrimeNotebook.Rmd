---
title: "Santa Monica"
output:
  pdf_document: default
  html_notebook: default
---

## Santa Monica Crimes Data

```{r}
rm(list=ls())
library(readr)
library(ggplot2)
library(dplyr)
library(lubridate)
library(forecast)

# Load in Incidents
incidents <- read_csv("~/desktop/santa-monica-light-rail/Data/Police_Incidents_Final.csv")
incidents$count = 1 # add count column for easy of aggregation
incidents = mutate(incidents, line_open_io = ifelse(Line_Open == "True", 1, 0))
head(incidents)
```

```{r}
# Set Up Variables


# all incidents aggregated by month
incidents.allByMonth <- incidents %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(total = n(),
            lineOpen = mean(line_open_io),
            totalHalfMile = sum(count[half_mile=="1"]),
            totalHalfToOneMile = sum(count[half_mile == "0" && one_mile == "1"]),
            violentHalfMile = sum(count[half_mile=="1" && `UCR Level 1` == "Violent"]),
            violentHalfToOneMile = sum(count[half_mile == "0" && one_mile == "1" && `UCR Level 1` == "Violent"]),
            violent = sum(count[`UCR Level 1` == "Violent"]),
            nonviolent = sum(count[`UCR Level 1` == "Non-Violent"]),
            larceny = sum(count[`UCR Level 2` == "Larceny"]))

head(incidents.allByMonth)

## Treatment
# all incidents a half-mile from the rail line by month
incidents.hmByMonth <- incidents %>%
  filter(half_mile == "1") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(total = n(),
            violent = sum(count[`UCR Level 1` == "Violent"]),
            nonviolent = sum(count[`UCR Level 1` == "Non-Violent"]),
            larceny = sum(count[`UCR Level 2` == "Larceny"]))

## Control
# all incidents between one mile and a half-mile from the rail line by month
incidents.oneToHmByMonth <- incidents %>%
  filter(half_mile == "0" & one_mile == "1") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(total = n(),
            violent = sum(count[`UCR Level 1` == "Violent"]),
            nonviolent = sum(count[`UCR Level 1` == "Non-Violent"]),
            larceny = sum(count[`UCR Level 2` == "Larceny"]))

```


```{r}
createTimeSeriesAndDecompose <- function(tsData, fq=12, stPeriod=c(2006,1)) {
  decompose(ts(tsData, frequency=fq, start=stPeriod))
}

all <- createTimeSeriesAndDecompose(incidents.allByMonth$total)
halfMile <- createTimeSeriesAndDecompose(incidents.hmByMonth$total)
oneToHalfMile <- createTimeSeriesAndDecompose(incidents.oneToHmByMonth$total)

vAll <- createTimeSeriesAndDecompose(incidents.allByMonth$violent)
vHalfMile <- createTimeSeriesAndDecompose(incidents.hmByMonth$violent)
vOneToHalfMile <- createTimeSeriesAndDecompose(incidents.oneToHmByMonth$violent)

nvAll <- createTimeSeriesAndDecompose(incidents.allByMonth$nonviolent)
nvHalfMile <- createTimeSeriesAndDecompose(incidents.hmByMonth$nonviolent)
nvOneToHalfMile <- createTimeSeriesAndDecompose(incidents.oneToHmByMonth$nonviolent)

larAll <- createTimeSeriesAndDecompose(incidents.allByMonth$larceny)
larHalfMile <- createTimeSeriesAndDecompose(incidents.hmByMonth$larceny)
larOneToHalfMile <- createTimeSeriesAndDecompose(incidents.oneToHmByMonth$larceny)

ts.plot(halfMile$trend,oneToHalfMile$trend, gpars = list(col = c("blue", "red")))
ts.plot(vHalfMile$trend, vOneToHalfMile$trend, gpars = list(col = c("blue", "red")))
ts.plot(nvHalfMile$trend, nvOneToHalfMile$trend, gpars = list(col = c("blue", "red")))
ts.plot(larHalfMile$trend, larOneToHalfMile$trend, gpars = list(col = c("blue", "red")))

plot(halfMile)
plot(oneToHalfMile)

```

```{r}

beforeAfterIncidents <- incidents.allByMonth[incidents.allByMonth$month >= "2015-05-20" & incidents.allByMonth$month <= "2017-05-20",]

# Regressions
# All Incidents
# treatment regression
treatReg <- lm(total ~  lineOpen + halfMile, data=regdf)
# controlReg <- lm(totalHalfToOneMile ~  lineOpen, data=beforeAfterIncidents)

print("Treatment")
summary(treatReg)

# print("Control")
# summary(controlReg)
```

```{r}
# All Incidents
# treatment regression
violentTreatReg <- lm(violent ~  lineOpen, data=beforeAfterIncidents)
violentControlReg <- lm(violentHalfToOneMile ~  lineOpen, data=beforeAfterIncidents)

print("Treatment")
summary(violentTreatReg)

print("Control")
summary(violentControlReg)
```
library(TTR)
tsIncidentsByDay = ts(incidents.allByDay$`count`, frequency=365, start(c(2006,1)))
incidentsDecomposed = decompose(tsIncidentsByDay)
plot(incidentsDecomposed)

tsTotalIncidentsByMonth = ts(incidents.allByMonth$`count`, frequency=12, start(c(2006,1)))
totalIncidentsDecomposed = decompose(tsTotalIncidentsByMonth)
plot(totalIncidentsDecomposed)

# all incidents aggregated by day
incidents.allByDay <- incidents %>%
  group_by(`Date Occurred`) %>%
  summarise(count=n())
  
# all incidents between one mile and a half-mile from the rail line by day
incidents.oneToHalfMileByDay <- incidents %>%
  filter(half_mile == "0" && one_mile == "1") %>%
  group_by(`Date Occurred`) %>% 
  summarise(count=n())
  
# all incidents within half mile aggregated by day
incidents.halfMileByDay <- incidents %>%
  filter(half_mile == "1") %>%
  group_by(`Date Occurred`) %>% 
  summarise(count=n())
## Non Violent

# all non violent incidents within half mile aggregated by month
incidents.nvHalfMilebyMonth <- incidents %>%
  filter(half_mile == "1" && `UCR Level 1` == "Non-Violent") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())

# all non-violent incidents aggregated by month
incidents.nvAllByMonth <- incidents %>%
  filter(`UCR Level 1` == "Non-Violent") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())

# all non-violent incidents aggregated by day
incidents.nvAllByDay <- incidents %>%
  filter(`UCR Level 1` == "Non-Violent") %>%
  group_by(`Date Occurred`) %>%
  summarise(count=n())

# all non-violent incidents within half mile aggregated by day
incidents.nvHalfMileByDay <- incidents %>%
  filter(half_mile == "1" && `UCR Level 1` == "Non-Violent") %>%
  group_by(`Date Occurred`) %>% 
  summarise(count=n())

# all non-violent incidents within half mile aggregated by month
incidents.nvHalfMilebyMonth <- incidents %>%
  filter(half_mile == "1" && `UCR Level 1` == "Non-Violent") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())

## Violent

# all violent incidents within half mile aggregated by month
incidents.vHalfMilebyMonth <- incidents %>%
  filter(half_mile == "1" && `UCR Level 1` == "Violent") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())

# all  violent incidents aggregated by month
incidents.vAllByMonth <- incidents %>%
  filter(`UCR Level 1` == "Violent") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())

# all violent incidents aggregated by day
incidents.vAllByDay <- incidents %>%
  filter(`UCR Level 1` == "Violent") %>%
  group_by(`Date Occurred`) %>%
  summarise(count=n())

# all violent incidents within half mile aggregated by day
incidents.vHalfMileByDay <- incidents %>%
  filter(half_mile == "1" && `UCR Level 1` == "Violent") %>%
  group_by(`Date Occurred`) %>% 
  summarise(count=n())

# all violent incidents within half mile aggregated by month
incidents.vHalfMilebyMonth <- incidents %>%
  filter(half_mile == "1" && `UCR Level 1` == "Violent") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())

## Larceny

# all larceny incidents within half mile aggregated by month
incidents.larHalfMilebyMonth <- incidents %>%
  filter(half_mile == "1" && `UCR Level 2` == "Larceny") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())

# all larceny incidents aggregated by month
incidents.larAllByMonth <- incidents %>%
  filter(`UCR Level 2` == "Larceny") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())

# all larceny incidents aggregated by day
incidents.larAllByDay <- incidents %>%
  filter(`UCR Level 2` == "Violent") %>%
  group_by(`Date Occurred`) %>%
  summarise(count=n())

# all larceny incidents within half mile aggregated by day
incidents.larHalfMileByDay <- incidents %>%
  filter(half_mile == "1" && `UCR Level 2` == "Larceny") %>%
  group_by(`Date Occurred`) %>% 
  summarise(count=n())

# all larceny incidents within half mile aggregated by month
incidents.larHalfMilebyMonth <- incidents %>%
  filter(half_mile == "1" && `UCR Level 2` == "Larceny") %>%
  group_by(month=floor_date(`Date Occurred`, 'month')) %>% 
  summarise(count=n())


plot(incidents.allByMonth$count ~ incidents.allByMonth$month, xlab="Month", ylab="Number of Incidents", type="l")
plot(incidents.allByDay$`count` ~ incidents.allByDay$`Date Occurred`, xlab="Month", ylab="Number of Incidents", type="l")
